#!/bin/bash


mvn clean install

rm -f native/apache-qpid-broker-j-8.0.6-bin.tar.gz

cp -f apache-qpid-broker-j/target/apache-qpid-broker-j-8.0.6-bin.tar.gz ../native/
cd ../native

rm -Rf qpid-broker
tar -xzf apache-qpid-broker-j-8.0.6-bin.tar.gz

cp -Rf ../apache-qpid-broker-j-8.0.6-src/src/main/resources/META-INF qpid-broker/8.0.6/lib/

cd qpid-broker/8.0.6/lib
native-image --no-fallback --enable-url-protocols=file -H:EnableURLProtocols=http,https -H:ReflectionConfigurationFiles=META-INF/native-image/reflect-config.json -H:ResourceConfigurationFiles=META-INF/native-image/resource-config.json -cp jar:/usr/local/src/qpid/Qpid4Graal/native/qpid-broker/8.0.6/lib/* --verbose -J-Xmx16g -J-XX:+HeapDumpOnOutOfMemoryError -J-XX:MaxDirectMemorySize=1536m -J-server -DPNAME=QPBRKR -DQPID_HOME=/usr/local/src/qpid/Qpid4Graal/native/qpid-broker/8.0.6 -DQPID_WORK=/var/qpidwork -jar qpid-broker-8.0.6.jar qpid
